pipeline {
    agent any
    tools {
        maven 'maven'
        jdk 'JDK11'
    }
    
    parameters {
        string(name: 'TAGS', defaultValue: '@login', description: 'Cucumber tags for the test, example @automated, @manual, @DFPORTALOB-31-002 etc ')
        choice(name: 'ENVIRONMENT', choices: ['uat', 'dev'], description: 'Choice environment dev or uat')

    }

   stages{
     stage('Build'){
          steps{
            script{
                if(isUnix()){
                    sh(script:"""
                    java --version
                    node -v
                    npm install
                    npx playwright install
                    """)
                } 
                else{
                    bat(script:"""
                    java --version
                    node -v
                    npx playwright install
                    npm install
                        
                    """)
                }
            }
          }
     }

      stage('Execute Tests'){
        steps{
             script{
                    try{
                        if(isUnix()){
                            echo "Executing tag: ${params.TAGS}"
                            sh 'npm run test-dev --tag="${params.TAGS}"'
                        }
                        else {
                            echo "Executing tag: ${params.TAGS}"
                            bat 'npm run test-dev --tag="${params.TAGS}"'
                        }
                    } finally{
                        publishReport();
                    }
                }
        }
      }

   }

}
   def publishReport(){
    publishHTML(target: [
        allowMissing: true,
        reportDir: 'test-results/reports/',
        reportFiles: 'index.html',
        keepAll: true,
        alwaysLinkToLastBuild: true,
        allowMissing: false

        
    ])
   }
                                                   
